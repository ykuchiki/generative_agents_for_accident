{% load staticfiles %}

<script type="text/javascript">
  // ###########################################################################
  // PREAMBLE
  // ###########################################################################

  let scene;
  let step = {{step}};
  let sim_code = "{{sim_code}}";
  let step_size = {{sec_per_step}} * 1000;

  // „Çµ„Éº„Éê„Éº„Åã„ÇâÊ∏°„Åï„Çå„ÅütileEvents„Éá„Éº„Çø
  let tileEvents = {{ all_tile_events|safe }};  // Â§âÊï∞Âêç„ÇíÁµ±‰∏Ä
  console.log('Tile Events:', tileEvents); // „Éá„Éê„ÉÉ„Ç∞Áî®
  let fires = {};

  // Phaser 3.0 global settings.
  const config = {
    type: Phaser.AUTO,
    width: 1500,
    height: 800,
    parent: "game-container",
    pixelArt: true,
    physics: {
      default: "arcade",
      arcade: {
        gravity: { y: 0 }
      }
    },
    scene: {
      preload: preload,
      create: create,
      update: update
    },
    scale: {zoom: 0.8}
  };

  const game = new Phaser.Game(config);
  let cursors;
  let player;

  let persona_names = {{ persona_init_pos|safe }};
  var spawn_tile_loc = {};
  for (var key in persona_names){
    spawn_tile_loc[key] = persona_names[key];
  }

  var personas = {};
  var pronunciatios = {};
  var speech_bubbles = {};
  let anims_direction;
  let pre_anims_direction;
  let pre_anims_direction_dict = {};

  let tile_width = 32;
  let movement_speed = {{play_speed}};
  let execute_count_max = tile_width/movement_speed;
  let execute_count = execute_count_max;
  let movement_target = {};
  let all_movement = {{ all_movement|safe }};

  let start_datetime = new Date(Date.parse("{{start_datetime}}"));
  var datetime_options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById("game-time-content").innerHTML = start_datetime.toLocaleTimeString("en-US", datetime_options);

  // ###########################################################################
  // ENGINE
  // ###########################################################################

  function preload() {
    this.load.crossOrigin = '';

    this.load.image("blocks_1", "{% static 'assets/the_ville/visuals/map_assets/blocks/blocks_1.png' %}");
    this.load.image("walls", "{% static 'assets/the_ville/visuals/map_assets/v1/Room_Builder_32x32.png' %}");
    this.load.image("interiors_pt1", "{% static 'assets/the_ville/visuals/map_assets/v1/interiors_pt1.png' %}");
    this.load.image("interiors_pt2", "{% static 'assets/the_ville/visuals/map_assets/v1/interiors_pt2.png' %}");
    this.load.image("interiors_pt3", "{% static 'assets/the_ville/visuals/map_assets/v1/interiors_pt3.png' %}");
    this.load.image("interiors_pt4", "{% static 'assets/the_ville/visuals/map_assets/v1/interiors_pt4.png' %}");
    this.load.image("interiors_pt5", "{% static 'assets/the_ville/visuals/map_assets/v1/interiors_pt5.png' %}");
    this.load.image("CuteRPG_Field_B", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Field_B.png' %}");
    this.load.image("CuteRPG_Field_C", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Field_C.png' %}");
    this.load.image("CuteRPG_Harbor_C", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Harbor_C.png' %}");
    this.load.image("CuteRPG_Village_B", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Village_B.png' %}");
    this.load.image("CuteRPG_Forest_B", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Forest_B.png' %}");
    this.load.image("CuteRPG_Desert_C", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Desert_C.png' %}");
    this.load.image("CuteRPG_Mountains_B", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Mountains_B.png' %}");
    this.load.image("CuteRPG_Desert_B", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Desert_B.png' %}");
    this.load.image("CuteRPG_Forest_C", "{% static 'assets/the_ville/visuals/map_assets/cute_rpg_word_VXAce/tilesets/CuteRPG_Forest_C.png' %}");

    this.load.image('fire', "{% static 'assets/fire.png' %}");
    this.load.tilemapTiledJSON("map", "{% static 'assets/the_ville/visuals/the_ville_jan7.json' %}");

    this.load.atlas("atlas", "{% static 'assets/characters/Yuriko_Yamamoto.png' %}",
                     "{% static 'assets/characters/atlas.json' %}");

    {% for p in persona_names %}
      {% with 'assets/characters/'|add:p.underscore|add:'.png' as image_static %}
        this.load.atlas("{{p.underscore}}", "{% static image_static %}",
                          "{% static 'assets/characters/atlas.json' %}");
      {% endwith %}
    {% endfor %}

    this.load.image('speech_bubble', "{% static 'assets/speech_bubble/v3.png' %}");
  }

  function create() {
      scene = this;  // `this`„Çí`scene`„Å´‰øùÂ≠ò
    const map = this.make.tilemap({ key: "map" });

    const collisions = map.addTilesetImage("blocks", "blocks_1");
    const walls = map.addTilesetImage("Room_Builder_32x32", "walls");
    const interiors_pt1 = map.addTilesetImage("interiors_pt1", "interiors_pt1");
    const interiors_pt2 = map.addTilesetImage("interiors_pt2", "interiors_pt2");
    const interiors_pt3 = map.addTilesetImage("interiors_pt3", "interiors_pt3");
    const interiors_pt4 = map.addTilesetImage("interiors_pt4", "interiors_pt4");
    const interiors_pt5 = map.addTilesetImage("interiors_pt5", "interiors_pt5");
    const CuteRPG_Field_B = map.addTilesetImage("CuteRPG_Field_B", "CuteRPG_Field_B");
    const CuteRPG_Field_C = map.addTilesetImage("CuteRPG_Field_C", "CuteRPG_Field_C");
    const CuteRPG_Harbor_C = map.addTilesetImage("CuteRPG_Harbor_C", "CuteRPG_Harbor_C");
    const CuteRPG_Village_B = map.addTilesetImage("CuteRPG_Village_B", "CuteRPG_Village_B");
    const CuteRPG_Forest_B = map.addTilesetImage("CuteRPG_Forest_B", "CuteRPG_Forest_B");
    const CuteRPG_Desert_C = map.addTilesetImage("CuteRPG_Desert_C", "CuteRPG_Desert_C");
    const CuteRPG_Mountains_B = map.addTilesetImage("CuteRPG_Mountains_B", "CuteRPG_Mountains_B");
    const CuteRPG_Desert_B = map.addTilesetImage("CuteRPG_Desert_B", "CuteRPG_Desert_B");
    const CuteRPG_Forest_C = map.addTilesetImage("CuteRPG_Forest_C", "CuteRPG_Forest_C");

    let tileset_group_1 = [CuteRPG_Field_B, CuteRPG_Field_C, CuteRPG_Harbor_C, CuteRPG_Village_B,
                           CuteRPG_Forest_B, CuteRPG_Desert_C, CuteRPG_Mountains_B, CuteRPG_Desert_B, CuteRPG_Forest_C,
                           interiors_pt1, interiors_pt2, interiors_pt3, interiors_pt4, interiors_pt5, walls];
    const bottomGroundLayer = map.createLayer("Bottom Ground", tileset_group_1, 0, 0);
    const exteriorGroundLayer = map.createLayer("Exterior Ground", tileset_group_1, 0, 0);
    const exteriorDecorationL1Layer = map.createLayer("Exterior Decoration L1", tileset_group_1, 0, 0);
    const exteriorDecorationL2Layer = map.createLayer("Exterior Decoration L2", tileset_group_1, 0, 0);
    const interiorGroundLayer = map.createLayer("Interior Ground", tileset_group_1, 0, 0);
    const wallLayer = map.createLayer("Wall", [CuteRPG_Field_C, walls], 0, 0);
    const interiorFurnitureL1Layer = map.createLayer("Interior Furniture L1", tileset_group_1, 0, 0);
    const interiorFurnitureL2Layer = map.createLayer("Interior Furniture L2 ", tileset_group_1, 0, 0);
    const foregroundL1Layer = map.createLayer("Foreground L1", tileset_group_1, 0, 0);
    const foregroundL2Layer = map.createLayer("Foreground L2", tileset_group_1, 0, 0);

    const collisionsLayer = map.createLayer("Collisions", collisions, 0, 0);

    collisionsLayer.setCollisionByProperty({ collide: true });
    collisionsLayer.setDepth(-1);  // „Ç≥„É™„Ç∏„Éß„É≥„É¨„Ç§„É§„Éº„ÅØË°®Á§∫„Åï„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´Ê∑±„Åï„Çí„Éû„Ç§„Éä„Çπ„Å´Ë®≠ÂÆö
    foregroundL1Layer.setDepth(5);
    foregroundL2Layer.setDepth(5);

    player = this.physics.add.sprite(2400, 588, "atlas", "down")
                         .setSize(30, 40)
                         .setOffset(0, 0);
    player.setDepth(-1);  // „Éó„É¨„Ç§„É§„Éº„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆ„Éá„Éó„Çπ„ÇíË®≠ÂÆö
    const camera = this.cameras.main;
    camera.startFollow(player);
    camera.setBounds(0, 0, map.widthInPixels, map.heightInPixels);
    cursors = this.input.keyboard.createCursorKeys();

    for (let i=0; i<Object.keys(spawn_tile_loc).length; i++) {
      let persona_name = Object.keys(spawn_tile_loc)[i];
      let start_pos = [spawn_tile_loc[persona_name][0] * tile_width + tile_width / 2,
                       spawn_tile_loc[persona_name][1] * tile_width + tile_width];
      let new_sprite = this.physics.add
                           .sprite(start_pos[0], start_pos[1], persona_name, "down")
                           .setSize(30, 40)
                           .setOffset(0, 0);
      new_sprite.displayWidth = 40;
      new_sprite.scaleY = new_sprite.scaleX;

      personas[persona_name] = new_sprite;
      speech_bubbles[persona_name] = this.add.image(new_sprite.body.x - 0, new_sprite.body.y - 30, 'speech_bubble').setDepth(10);
      speech_bubbles[persona_name].displayWidth = 130;
      speech_bubbles[persona_name].displayHeight = 58;

      pronunciatios[persona_name] = this.add.text(
                                     new_sprite.body.x - 6,
                                     new_sprite.body.y - 42,
                                     "ü¶Å", {
                                     font: "24px monospace",
                                     fill: "#000000",
                                     padding: { x: 8, y: 8},
                                     border:"solid",
                                     borderRadius:"10px"}).setDepth(10);

      new_sprite.setDepth(2); // „Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„Éá„Éó„Çπ„Çí2„Å´Ë®≠ÂÆö
    }

    const anims = this.anims;
    for (let i=0; i<Object.keys(persona_names).length; i++) {
      let persona_name = Object.keys(persona_names)[i];
      let left_walk_name = persona_name + "-left-walk";
      let right_walk_name = persona_name + "-right-walk";
      let down_walk_name = persona_name + "-down-walk";
      let up_walk_name = persona_name + "-up-walk";

      anims.create({
        key: left_walk_name,
        frames: anims.generateFrameNames(persona_name, { prefix: "left-walk.", start: 0, end: 3, zeroPad: 3 }),
        frameRate: 4,
        repeat: -1 });

      anims.create({
        key: right_walk_name,
        frames: anims.generateFrameNames(persona_name, { prefix: "right-walk.", start: 0, end: 3, zeroPad: 3 }),
        frameRate: 4,
        repeat: -1 });

      anims.create({
        key: down_walk_name,
        frames: anims.generateFrameNames(persona_name, { prefix: "down-walk.", start: 0, end: 3, zeroPad: 3 }),
        frameRate: 4,
        repeat: -1 });

      anims.create({
        key: up_walk_name,
        frames: anims.generateFrameNames(persona_name, { prefix: "up-walk.", start: 0, end: 3, zeroPad: 3 }),
        frameRate: 4,
        repeat: -1 });
    }

    updateFireEffects(step);
  }

  //////////////////////////////////////////////////////////
  // ÁÅ´‰∫ã„Ç¢„ÇØ„Ç∑„Éá„É≥„ÉàÈñ¢ÈÄ£„ÅÆËøΩÂä†
  //////////////////////////////////////////////////////////

  function updateFireEffects(currentStep) {
    for (let coord in fires) {
      hideFireOnTile(...coord.split('_').map(Number));
    }

    for (let tileCoord in tileEvents) {  // Â§âÊï∞Âêç„ÇítileEvents„Å´Áµ±‰∏Ä
      let eventsByStep = tileEvents[tileCoord];
      if (eventsByStep[currentStep]) {
        let events = eventsByStep[currentStep];
        for (let event of events) {
          if (event[event.length - 1] && event[event.length - 1].includes("fire")) {
            let [tileX, tileY] = tileCoord.split('_').map(Number);
            showFireOnTile.call(this, tileX, tileY);
            console.log('Fire shown on tile:', tileX, tileY);
          }
        }
      }
    }
  }

  function advanceStep() {
    step += 1;
    updateFireEffects(step);
    start_datetime = new Date(start_datetime.getTime() + step_size);
    document.getElementById("game-time-content").innerHTML = start_datetime.toLocaleTimeString("en-US", datetime_options);

    // Êõ¥Êñ∞„Åï„Çå„Åü„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Çí„Çµ„Éº„Éê„Éº„Å´ÈÄÅ‰ø°„Åó„ÄÅ„É™„ÇØ„Ç®„Çπ„ÉàÂÆå‰∫ÜÊôÇ„Å´ÂêåÊúü„ÇíÂèñ„Çã
    sendTimeValueToServer(start_datetime, step);
}

    function sendTimeValueToServer(currentTime, currentStep) {
        let xhr = new XMLHttpRequest();
        xhr.open('POST', '/set_time_value/', true);
        xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                console.log('Time value sent');
                const response = JSON.parse(xhr.responseText);
                if (response.status === 'success') {
                    updateFireEffects(currentStep); // „Çµ„Éº„Éê„Éº„ÅÆÂøúÁ≠î„ÇíÂæÖ„Å£„Å¶„Åã„ÇâÊõ¥Êñ∞
                } else {
                    console.error('Failed to set time value.');
                }
            }
        };
        let data = new FormData();
        data.append('time', currentTime.toISOString());
        data.append('step', currentStep);
        xhr.send(data);
    }

    function updateFireEffects(currentStep) {
        console.log('Updating fire effects for step:', currentStep);
        for (let coord in fires) {
            hideFireOnTile(...coord.split('_').map(Number));
        }

        for (let tileCoord in tileEvents) {
            let eventsByStep = tileEvents[tileCoord];
            if (eventsByStep[currentStep]) {
                let events = eventsByStep[currentStep];
                for (let event of events) {
                    if (event[event.length - 1] && event[event.length - 1].includes("fire")) {
                        let [tileX, tileY] = tileCoord.split('_').map(Number);
                        showFireOnTile(tileX, tileY);
                    }
                }
            }
        }
    }

    function showFireOnTile(tileX, tileY) {
        if (!fires[`${tileX}_${tileY}`]) {
            let fire = scene.add.sprite(tileX * tile_width, tileY * tile_width, 'fire')
                .setScale(0.05);
            fire.setDepth(1);
            fires[`${tileX}_${tileY}`] = fire;
        }
    }

    function hideFireOnTile(tileX, tileY) {
        if (fires[`${tileX}_${tileY}`]) {
            fires[`${tileX}_${tileY}`].destroy();
            delete fires[`${tileX}_${tileY}`];
        }
    }


  function update(time, delta) {
    let play_context = this;
    function game_resume() {
      play_context.scene.resume();
    }
    play_button.onclick = function(){
      game_resume();
    };
    function game_pause() {
      play_context.scene.pause();
    }
    pause_button.onclick = function(){
      game_pause();
    };

    const camera_speed = 400;
    player.body.setVelocity(0);
    if (cursors.left.isDown) {
      player.body.setVelocityX(-camera_speed);
    }
    if (cursors.right.isDown) {
      player.body.setVelocityX(camera_speed);
    }
    if (cursors.up.isDown) {
      player.body.setVelocityY(-camera_speed);
    }
    if (cursors.down.isDown) {
      player.body.setVelocityY(camera_speed);
    }

    let curr_focused_persona = document.getElementById("temp_focus").textContent;
    if (curr_focused_persona != "") {
      player.body.x = personas[curr_focused_persona].body.x;
      player.body.y = personas[curr_focused_persona].body.y;
      document.getElementById("temp_focus").innerHTML = "";
    }

    for (let i=0; i<Object.keys(personas).length; i++) {
      let curr_persona_name = Object.keys(personas)[i];
      let curr_persona = personas[curr_persona_name];
      let curr_pronunciatio = pronunciatios[Object.keys(personas)[i]];
      let curr_speech_bubble = speech_bubbles[Object.keys(personas)[i]];

      if (curr_persona_name.replace("_", " ") in all_movement[step]) {
        if (execute_count == execute_count_max) {
          let curr_x = all_movement[step][curr_persona_name.replace("_", " ")]["movement"][0]
          let curr_y = all_movement[step][curr_persona_name.replace("_", " ")]["movement"][1]
          movement_target[curr_persona_name] = [curr_x * tile_width, curr_y * tile_width];
          let pronunciatio_content = all_movement[step][curr_persona_name.replace("_", " ")]["pronunciatio"];
          let description_content = all_movement[step][curr_persona_name.replace("_", " ")]["description"];
          let chat_content_raw = all_movement[step][curr_persona_name.replace("_", " ")]["chat"];

          let chat_content = "";
          if (chat_content_raw != null ){
            for (let j=0; j<chat_content_raw.length; j++) {
              chat_content += chat_content_raw[j][0] + ": " + chat_content_raw[j][1] + "<br>"
            }
          } else {
            chat_content = "<em>None at the moment</em>"
          }

          let rgx = new RegExp(/(\p{L}{1})\p{L}+/, 'gu');
          let initials = [...curr_persona_name.matchAll(rgx)] || [];
          initials = (
            (initials.shift()?.[1] || '') + (initials.pop()?.[1] || '')
          ).toUpperCase();
          pronunciatios[curr_persona_name].setText(initials + ": " + pronunciatio_content);

          document.getElementById("quick_emoji-"+curr_persona_name).innerHTML = pronunciatio_content;
          document.getElementById("current_action__"+curr_persona_name).innerHTML = description_content.split("@")[0];
          document.getElementById("target_address__"+curr_persona_name).innerHTML = description_content.split("@")[1];
          document.getElementById("chat__"+curr_persona_name).innerHTML = chat_content;
        }

        if (execute_count > 0) {
          if (curr_persona.body.x < movement_target[curr_persona_name][0]) {
            curr_persona.body.x += movement_speed;
            anims_direction = "r";
            pre_anims_direction = "r"
            pre_anims_direction_dict[curr_persona_name] = "r"
          } else if (curr_persona.body.x > movement_target[curr_persona_name][0]) {
            curr_persona.body.x -= movement_speed;
            anims_direction = "l";
            pre_anims_direction = "l"
            pre_anims_direction_dict[curr_persona_name] = "l"
          } else if (curr_persona.body.y < movement_target[curr_persona_name][1]) {
            curr_persona.body.y += movement_speed;
            anims_direction = "d";
            pre_anims_direction = "d"
            pre_anims_direction_dict[curr_persona_name] = "d"
          } else if (curr_persona.body.y > movement_target[curr_persona_name][1]) {
            curr_persona.body.y -= movement_speed;
            anims_direction = "u";
            pre_anims_direction = "u"
            pre_anims_direction_dict[curr_persona_name] = "u"
          } else {
            anims_direction = "";
          }

          curr_pronunciatio.x = curr_persona.body.x + 18;
          curr_pronunciatio.y = curr_persona.body.y - 42 - 25;
          curr_speech_bubble.x = curr_persona.body.x + 80;
          curr_speech_bubble.y = curr_persona.body.y - 39;

          let left_walk_name = curr_persona_name + "-left-walk";
          let right_walk_name = curr_persona_name + "-right-walk";
          let down_walk_name = curr_persona_name + "-down-walk";
          let up_walk_name = curr_persona_name + "-up-walk";
          if (anims_direction == "l") {
            curr_persona.anims.play(left_walk_name, true);
          } else if (anims_direction == "r") {
            curr_persona.anims.play(right_walk_name, true);
          } else if (anims_direction == "u") {
            curr_persona.anims.play(up_walk_name, true);
          } else if (anims_direction == "d") {
            curr_persona.anims.play(down_walk_name, true);
          };
        }
      } else {
        curr_persona.anims.stop();
        if (pre_anims_direction_dict[curr_persona_name] == "l") curr_persona.setTexture(curr_persona_name, "left"); else
        if (pre_anims_direction_dict[curr_persona_name] == "r") curr_persona.setTexture(curr_persona_name, "right"); else
        if (pre_anims_direction_dict[curr_persona_name] == "u") curr_persona.setTexture(curr_persona_name, "up"); else
        if (pre_anims_direction_dict[curr_persona_name] == "d") curr_persona.setTexture(curr_persona_name, "down");
      }
    }

    if (execute_count == 0) {
      for (let i = 0; i < Object.keys(personas).length; i++) {
        let curr_persona_name = Object.keys(personas)[i]
        let curr_persona = personas[curr_persona_name];
        curr_persona.body.x = movement_target[curr_persona_name][0];
        curr_persona.body.y = movement_target[curr_persona_name][1];
      }
      execute_count = execute_count_max + 1;
      step = step + 1;

      start_datetime = new Date(start_datetime.getTime() + step_size);
      document.getElementById("game-time-content").innerHTML = start_datetime.toLocaleTimeString("en-US", datetime_options);

      let xhr = new XMLHttpRequest();
      xhr.open('POST', '/set_time_value/', true);
      xhr.setRequestHeader('X-CSRFToken', '3yrZ5L42aqk9ZE4UY14NxyPQatg9oMzrUyy4sBkcbRbcesuvXIJG0n6ATxlQTXyQ');
      xhr.onreadystatechange = function() {
          if (xhr.readyState == 4 && xhr.status == 200) {
              console.log('Time value sent');
              const response = JSON.parse(xhr.responseText);
              if (response.status === 'success') {
                  updateFireEffects(step);
              } else {
                  console.error('Failed to set time value.');
              }
          }
      };
      let data = new FormData();
      data.append('time', start_datetime.toISOString());
      data.append('step', step);
      xhr.send(data);
    }

    execute_count -= 1;
  }

  var play_button=document.getElementById("play_button");
  var pause_button=document.getElementById("pause_button");
</script>
